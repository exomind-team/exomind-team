---
title: ExoMind 架构设计
date: 2026-01-20
model: MiniMax / Claude
tools: Claude Code, VS Code
author: HailayLin
ai-collaborator: true
---

# ExoMind 架构设计 Spec 文档

> 生成时间：2026-01-20
> 目标：明确系统架构，与其他项目对比

---

## 1. 架构概览 🎯

### 1.1 6层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ExoMind 7层架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ 第7层 │ UI层           │ core/ui/           │ 通用UI组件（跨端共享）         │
│       │                │ apps/*/ui/         │ 各端专用UI实现                 │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第6层 │ 业务层          │ core/business/     │ 通用业务逻辑                   │
│       │                │ apps/*/business/   │ 平台适配业务                   │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第5层 │ 事件总线        │ core/event-bus/    │ Actor内模块通讯                │
│       │                │ (含轻量级实现)      │ 各端可替换                     │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第4层 │ 数据层          │ core/data/         │ 区块链数据结构                 │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第3层 │ 同步引擎        │ core/sync/         │ 同步策略+冲突解决              │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第2层 │ 存储层          │ core/storage/      │ SQLite/IndexedDB本地存储       │
├───────┼────────────────┼────────────────────┼───────────────────────────────┤
│ 第1层 │ 网络层          │ core/network/      │ mDNS+P2P+WebSocket             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**依赖方向**：第1层→第2层→第3层→第4层→第5层→第6层→第7层
**说明**：
- 存储层（第2层）存在！数据存储在 SQLite (桌面/服务器) 或 IndexedDB (Web/移动端)
- UI层（第7层）包含 core/ui/（通用组件）+ apps/*/ui/（各端专用）

### 1.2 核心设计原则

| 原则        | 说明               |
| --------- | ---------------- |
| **离线优先**  | 每端独立运行，不依赖网络     |
| **依赖方向**  | 上层依赖下层，下层不依赖上层   |
| **事件驱动**  | Actor内模块通过事件总线通讯 |
| **只追加同步** | 数据不可篡改，通过时间戳合并   |
| **代码复用**  | core库供所有端共享      |

---

## 2. 架构层级详解 📦

### 第1层：网络层

**职责**：设备发现与数据传输

| 功能 | 技术 |
|------|------|
| 局域网发现 | mDNS (Avahi/Bonjour) |
| P2P通讯 | WebRTC / libp2p |
| 远程通讯 | WebSocket / gRPC |

**文件位置**：`core/network/`

---

### 第2层：存储层

**职责**：本地数据持久化

| 端 | 技术 | 说明 |
|---|------|------|
| 桌面端 | SQLite | 结构化数据存储 |
| 服务器 | SQLite | 同桌面端 |
| Web端 | IndexedDB (Dexie.js) | 浏览器内置存储 |
| 移动端 | IndexedDB / SQLite | 移动端适配 |

**文件位置**：`core/storage/`

---

### 第3层：同步引擎

**职责**：数据同步策略与冲突解决

| 功能 | 说明 |
|------|------|
| 同步标记 | 记录同步位置 |
| 差异对比 | 找出缺失的Block |
| 冲突处理 | 按时间戳+设备ID合并 |
| 按需同步 | 支持只拉取部分历史 |

**文件位置**：`core/sync/`

---

### 第4层：数据层

**职责**：区块链式数据结构

```typescript
// 数据块结构
interface Block {
  id: string;              // UUID v4
  deviceId: string;        // 设备标识 (如 "linux-pc@ubuntu")
  timestamp: number;       // Unix时间戳(毫秒)
  type: EventType;         // 事件类型
  payload: any;            // 数据内容
  previousHash: string;    // 前一个块的hash
  signature: string;       // 数字签名
  metadata: {
    source: string;
    version: number;
  };
}

// 链结构
interface Chain {
  blocks: Block[];
  deviceId: string;
  lastHash: string;
}
```

**特点**：只追加、不可篡改、可追溯

**文件位置**：`core/data/blockchain/`

---

### 第5层：事件总线

**职责**：Actor内模块解耦

| 功能 | 说明 |
|------|------|
| 订阅-发布 | 模块间松耦合 |
| 事件类型 | 定义所有事件 |
| 标准实现 | mitt3 / EventEmitter |
| 轻量级实现 | 手环端使用简化版本 |

**说明**：不同端可能有不同实现，接口统一

**使用示例**：
```typescript
// 订阅
eventBus.on('time-block.start', (data) => {
  // 处理开始
});

// 发布
eventBus.emit('message.create', { content: 'Hello' });
```

**文件位置**：`core/event-bus/`

---

### 第6层：业务层

**职责**：业务规则与平台适配

```
业务层 = 通用业务 + 平台适配

┌────────────────────────────────────────────────────────┐
│ core/business/        (通用业务 - 所有端共享)          │
│ ├── time-block/       │ 时间块核心规则                 │
│ ├── message/          │ 消息核心规则                   │
│ └── ai-agent/         │ AI Agent核心规则               │
├────────────────────────────────────────────────────────┤
│ apps/*/business/      (平台适配 - 各端独立)            │
│ ├── desktop/          │ Tauri适配、桌面特定逻辑        │
│ ├── android/          │ Android适配、手机特定逻辑      │
│ └── web/              │ Web适配、浏览器特定逻辑        │
└────────────────────────────────────────────────────────┘
```

**必要性**：不同设备能力不同，必须做平台适配

---

### 第7层：UI层

**职责**：各端UI实现

**技术框架**：Tauri + React + TypeScript + Vite + TailwindCSS + shadcn/ui + Radix UI

| 端 | 技术 | 特点 |
|---|------|------|
| Desktop | Tauri 2.x + React | 窗口管理、系统托盘 |
| Android | Tauri 2.x + React Native / WebView | 蓝牙连接、通知 |
| Web | React 18/19 + Vite | 浏览器API |
| CLI/TUI | Rust / TypeScript | 终端交互 |

**通用组件**：`core/ui/` 存放跨端共享的UI组件（按钮、输入框、列表等）

**专用UI**：`apps/*/ui/` 存放各端专用UI（窗口管理、系统托盘、Android Activity等）

**文件位置**：`core/ui/` + `apps/*/ui/`

---

## 3. 文件夹结构 📁

### 3.1 整体结构

```
ExoMind/
├── core/                          # 核心库（7层架构）
│   ├── ui/                        # UI通用组件（第7层）
│   ├── business/                  # 通用业务（第6层）
│   ├── event-bus/                 # 事件总线（第5层）
│   ├── data/                      # 数据层（第4层）
│   │   └── blockchain/            # 区块链结构
│   ├── sync/                      # 同步引擎（第3层）
│   ├── storage/                   # 存储层（第2层）
│   ├── network/                   # 网络层（第1层）
│   └── utils/                     # 工具函数
│
├── apps/                          # 多端应用
│   ├── desktop/                   # Tauri桌面端
│   │   ├── main.ts
│   │   ├── ui/                    # 平台专用UI
│   │   └── business/              # 平台适配业务
│   ├── android/                   # Android端
│   ├── web/                       # Web端
│   └── cli/                       # CLI/TUI端
│
└── packages/                      # 共享包
    ├── types/                     # TypeScript类型
    ├── utils/                     # 工具函数
    └── constants/                 # 常量定义
```

### 3.2 复用原则

- ✅ 能用core的就不用apps的
- ✅ apps只放平台相关的代码
- ✅ 通用组件放在 `core/ui/`

---

## 4. 与其他项目对比 🔍

### 4.1 调研项目

| 项目           | 技术栈                      | 架构特点                 |
| ------------ | ------------------------ | -------------------- |
| **Obsidian** | Electron+TypeScript      | 离线优先、插件系统、JSON存储     |
| **Logseq**   | ClojureScript+Datascript | 图数据库、本地优先、Logseq DB  |
| **Raycast**  | React+TypeScript         | 扩展机制、React Query状态管理 |
| **Anytype**  | TypeScript+Rust          | 去中心化、本地加密            |

### 4.2 对比表格

| 维度           | ExoMind | Obsidian | Logseq  | Raycast |
| ------------ | ------- | -------- | ------- | ------- |
| **层数**       | 7层      | 3层       | 4层      | 3层      |
| **离线优先**     | ✅       | ✅        | ✅       | ✅       |
| **多端支持**     | ✅ (4端)  | ✅ (3端)   | ✅ (3端)  | ❌       |
| **事件总线**     | ✅       | ❌        | ❌       | ❌       |
| **Actor模式**  | ✅       | ❌        | ❌       | ❌       |
| **区块链同步**    | ✅       | ❌ (JSON) | ❌ (Git) | ❌       |
| **Monorepo** | ✅       | ❌        | ❌       | ✅       |

### 4.3 优势分析

1. **6层清晰分层**：依赖关系清晰，便于维护和测试
2. **事件总线**：Actor内模块解耦，支持复杂业务逻辑
3. **区块链同步**：只追加不篡改，可追溯
4. **多端共享**：core库复用代码，降低开发成本

### 4.4 局限性

1. **复杂度较高**：6层架构学习成本高
2. **同步引擎**：MVP阶段可能过度设计
3. **生态**：没有Obsidian的插件生态

---

## 5. 下一步计划 📋

### 5.1 Spec文档清单

| 阶段   | 文档            | 状态  |
| ---- | ------------- | --- |
| 需求分析 | 需求规格说明书 (SRS) | 待编写 |
| 技术选型 | 技术选型报告        | 已完成 |
| 架构设计 | 架构设计文档        | 本文档 |
| 模块设计 | 模块设计规格书       | 待编写 |
| 数据设计 | 数据结构设计        | 待编写 |

### 5.2 编码计划

1. **Day 1-2**：环境搭建 + 项目骨架 + Monorepo配置
2. **Day 3-4**：核心库 (network → sync → data → event-bus)
3. **Day 5-6**：业务层 (time-block → message → ai-agent)
4. **Day 7-8**：UI层 + 各端适配
5. **Day 9-10**：集成测试 + 打包发布

---

## 6. 附录：设备连接图 📡

```
                    ┌─────────────────┐
                    │   服务器        │
                    │  (CLI/TUI/Web)  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ↓                    ↓                    ↓
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  Linux PC     │  │  Android      │  │  Desktop GUI  │
│  (核心服务)    │  │  (本地枢纽)   │  │  (Win/macOS)  │
└───────────────┘  └───────────────┘  └───────────────┘
        │                    │
        └────────────────────┘
                    │
                    ↓
        ┌───────────────────────┐
        │   小米手环9Pro        │
        │   (数据采集)          │
        └───────────────────────┘

✓ 手机 ←→ 服务器
✓ Linux ←→ 服务器
✓ GUI ←→ 服务器
✗ 手环 ←→ 服务器 (❌ 需手机中转)
✗ 手环 ←→  PC (❌ 需手机中转)
```

---

*文档版本：1.0*
*最后更新：2026-01-20*
