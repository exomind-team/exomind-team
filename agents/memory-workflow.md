# Agent 记忆与状态更新流程

> 本文件定义了所有 Agent 通用的记忆更新流程和文件管理规范。
> 每个 Agent 的 `agent.md` 应引用本文件，并在「3.1 记忆与状态更新流程」章节中说明：
> - 「遵循 `life-os/core/memory-workflow.md` 中的通用流程」
> - 仅记录本 Agent 特有的读取/写入文件

## 1. 概述

每个 Agent 在任务执行过程中，需要遵循以下统一的文件更新流程，确保：
- 📋 任务状态可追踪
- 🔄 资源使用可量化
- 🧠 记忆可积累和复用
- 📈 运行状态可监控

## 2. 文件结构规范

### 2.1. 必需目录结构

```
[agent-name]/
├── agent.md              # 角色定义（引用本流程）
├── tasks_plan.md         # 任务队列
├── vitals/               # 生命体征
│   ├── ledger.md         # 资源账本
│   └── health.md         # 健康状态
├── memory/               # 记忆系统
│   ├── long-term.md      # 长期记忆
│   └── patches/          # 记忆补丁
├── .logs/                # 会话日志
├── scratch/              # 临时草稿
└── skills/               # 专用技能（可选）
```

### 2.2. 文件职责

| 文件 | 职责 | 更新频率 |
|------|------|----------|
| `agent.md` | 角色定义、版本历史 | 有新功能时 |
| `tasks_plan.md` | 任务队列、任务历史 | 每任务 |
| `vitals/ledger.md` | 资源消耗统计 | 每任务 |
| `vitals/health.md` | 运行状态、健康指标 | 每任务 |
| `memory/long-term.md` | 用户偏好、经验积累 | 有新发现时 |
| `memory/patches/` | 记忆增量更新 | 有新发现时 |
| `.logs/` | 会话历史 | 每任务 |
| `scratch/` | 临时思考 | 执行中 |
| `skills/` | 专用技能 | 有新增时 |

## 3. 任务生命周期

### 3.1. 任务开始前（读取阶段）

| 文件 | 操作 | 说明 |
|------|------|------|
| `tasks_plan.md` | **读取** | 确认当前任务状态、验收标准 |
| `vitals/ledger.md` | **读取** | 了解资源使用情况、预算余量 |
| `vitals/health.md` | **读取** | 了解当前状态、连续成功/失败次数 |
| `memory/long-term.md` | **读取** | 获取用户偏好、历史经验 |

### 3.2. 任务执行中（临时阶段）

| 文件 | 操作 | 说明 |
|------|------|------|
| `scratch/` | **写入** | 临时思考过程、草稿、调试信息 |
| `.logs/` | **可能写入** | 记录关键决策点（如有必要） |

### 3.3. 任务完成后（更新阶段）

#### 第一步：更新 `tasks_plan.md`

```markdown
### [已完成] 任务名称

- **任务ID**: xxx
- **开始时间**: YYYY-MM-DD HH:MM
- **结束时间**: YYYY-MM-DD HH:MM
- **状态**: 已完成
- **描述**: 简要描述

**验收结果**:
- [x] 验收标准1
- [x] 验收标准2
```

#### 第二步：更新 `vitals/ledger.md`

| 更新位置 | 更新内容 |
|----------|----------|
| 任务执行记录表 | 添加新行：任务ID、名称、输入/输出Tokens、评分 |
| 更新日志 | 记录本次执行的时间和任务 |

#### 第三步：更新 `vitals/health.md`

| 更新位置 | 更新内容 |
|----------|----------|
| 运行状态 | 连续成功+1，最后运行时间更新为当前时间 |
| 技能健康度 | 标记本次使用的技能为「已验证」 |
| 更新日志 | 记录本次执行的关键信息 |

#### 第四步：评估是否更新 `memory/long-term.md`

| 判断条件 | 操作 |
|----------|------|
| 发现新的用户偏好 | 创建补丁：`memory/patches/YYYY-MM-DD-新偏好.md` |
| 积累新的经验模式 | 创建补丁：`memory/patches/YYYY-MM-DD-新经验.md` |
| 需要修正已有内容 | 创建补丁：`memory/patches/YYYY-MM-DD-修正.md` |
| 无需更新 | 跳过 |

#### 第五步：更新 `memory/long-term.md` 的更新日志

```markdown
## 更新日志

- **YYYY-MM-DD HH:MM**: [操作类型] [简要描述]
```

## 4. 通用更新规则

| 规则 | 说明 |
|------|------|
| **先读后写** | 更新任何文件前，先读取当前内容 |
| **增量更新** | 只添加新内容，不删除已有内容 |
| **留痕原则** | 所有更新都记录在「更新日志」或「任务历史」中 |
| **补丁机制** | 长期记忆通过补丁更新，不直接修改原文件 |
| **版本记录** | `agent.md` 记录版本历史，`vitals/` 记录执行历史 |

## 5. 文件更新优先级

```
1. tasks_plan.md     → 标记任务完成（必须）
2. vitals/ledger.md  → 记录资源使用（必须）
3. vitals/health.md  → 更新运行状态（必须）
4. memory/patches/   → 如有需要（可选）
5. memory/long-term.md → 更新日志（必须）
6. .logs/            → 记录执行日志（必须）
```

## 6. 补丁格式规范

### 6.1. 补丁文件命名

```
memory/patches/YYYY-MM-DD-操作类型-描述.md
```

示例：
- `2026-01-14-新偏好-可视化格式.md`
- `2026-01-15-新经验-语音识别模式.md`
- `2026-01-16-修正-任务定位规则.md`

### 6.2. 补丁模板

```markdown
# 记忆补丁 - YYYY-MM-DD

## 修改类型
**新增 / 修正 / 删除**

## 修改内容

### 原内容
```
[原有内容]
```

### 新内容
```
[新内容]
```

## 修改原因
[简要说明]

## 关联任务
- 任务ID: xxx
- 来源: xxx

## 创建时间
YYYY-MM-DD HH:MM
```

## 7. 版本管理

### 7.1. agent.md 版本记录

```markdown
## 更新历史

### v1.X (YYYY-MM-DD) - 功能名称
- [变更点1]
- [变更点2]

### v1.Y (YYYY-MM-DD) - 功能名称
- [变更点1]
```

### 7.2. vitals/ 更新日志

```markdown
## 更新日志

- **YYYY-MM-DD HH:MM**: [操作类型] [简要描述]
- **YYYY-MM-DD HH:MM**: [操作类型] [简要描述]
```

## 8. 在 Agent 中引用本流程

在每个 Agent 的 `agent.md` 中，添加以下内容：

```markdown
## 3.1. 记忆与状态更新流程

本 Agent 遵循 `life-os/core/memory-workflow.md` 中的通用流程。

### 本 Agent 特有的文件操作

| 文件 | 操作 | 说明 |
|------|------|------|
| `特殊文件A` | 读取/写入 | 特殊用途说明 |
| `特殊文件B` | 读取/写入 | 特殊用途说明 |
```

## 9. 最佳实践

### 9.1. 任务执行前

- [ ] 确认 `tasks_plan.md` 中的任务状态
- [ ] 检查 `vitals/ledger.md` 中的资源余量
- [ ] 回顾 `memory/long-term.md` 中的用户偏好

### 9.2. 任务执行中

- [ ] 在 `scratch/` 中记录关键思考
- [ ] 如有重大决策，记录到 `.logs/`

### 9.3. 任务执行后

- [ ] 更新 `tasks_plan.md` 状态
- [ ] 更新 `vitals/ledger.md`
- [ ] 更新 `vitals/health.md`
- [ ] 评估是否需要创建补丁
- [ ] 更新 `memory/long-term.md` 的更新日志
- [ ] 执行 `git commit`

## 10. 更新日志

- **2026-01-14**: 初始化通用记忆更新流程
